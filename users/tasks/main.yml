- name: install
  yum:
    name: 'sudo'
    update_cache: yes
    state: latest
  when: ansible_distribution in ['CentOS', 'Red Hat Enterprise Linux', 'Fedora']

- name: install
  apt:
    name: 'sudo'
    update_cache: yes
    state: latest
  when: ansible_distribution in ['Debian', 'Ubuntu']

- group:
    name: supergroup
    state: present

- name: add groups
  group:
    name: "{{ item }}"
    state: present
  with_items:
    - "{{ groups_to_add }}"
  when: groups_to_add is defined

- name: add users
  user:
    name: "{{ item.name }}"
    createhome: yes
    state: "{{ item.state }}"
    groups: "{{ item.groups }}"
    home: "{{ item.home | default(omit) }}"
  with_items:
    - "{{ users }}"

- name: Set authorized key took from vars
  authorized_key:
    user: "{{ item.name }}"
    state: "{{ item.state }}"
    key: "{{ item.ssh_key }}"
  with_items:
    - "{{ ssh_key }}"

- copy:
    src: sudoers
    dest: /etc/sudoers
    owner: root
    group: root
    mode: 0644
